import streamlit as st
import google.generativeai as genai
import pandas as pd
import plotly.express as px
import random
import os

# --- 3. ุญุงูุธ ุนูู ุทุฑููุฉ ุฌูุจ ุงูู Secrets. ---
try:
    # ุจูุฌูุจ ููุชุงุญ ุงูู API ููุฌูููู ูู ููู secrets.toml
    gemini_api_key = st.secrets["GEMINI_API_KEY"]
    genai.configure(api_key=gemini_api_key)
except KeyError:
    st.error("ูุจุฏู ุฅูู ููุชุงุญ ุงูู GEMINI_API_KEY ูุด ููุฌูุฏ. ูุฑุฌู ุฅุถุงูุชู ูููู secrets.toml ุนุดุงู ุงูุฑุนุฏ ูุดุชุบู ุตุญ.")
    st.stop() # ุฅููุงู ุงูุชุทุจูู ุฅุฐุง ูุงู ุงูููุชุงุญ ูุด ููุฌูุฏ

# --- 2. ุญุงูุธ ุนูู ุฏุงูุฉ 'update_self' ููุง ูู ุฏูู ุฃู ุชุบููุฑ. ---
# ููุงุญุธุฉ ุงุณุชุฑุงุชูุฌูุฉ: ูุฐู ุงูุฏุงูุฉ ุชู ุชูููุฑูุง ูุฌุฒุก ูู ุงูุชุนูููุงุช ุงูุตุงุฑูุฉุ
# ููู ููุง ุชูุซู ูุญุงูุงุฉ ููุฌูุฏ ุขููุฉ ููุชุญุฏูุซ ุงูุฐุงุชู ููุฑุนุฏุ ุจุฏูู ุชูููุฐ
# ุชุญุฏูุซ ูุนูู ููููุฏ ุถูู ูุฐุง ุงูุณูุฑูุจุช ุงููุงุญุฏ.
def update_self(new_code_segment: str, feature_name: str):
    """
    ูุธููุฉ ุงูุฑุนุฏ ูุชุญุฏูุซ ููุณู ุฐุงุชูุงู ุจูุงุกู ุนูู ุชุญููู ุงูุงุญุชูุงุฌุงุช ุงูุงุณุชุฑุงุชูุฌูุฉ.
    (ุชู ุงูุญูุงุธ ุนูููุง ููุง ูู ุญุณุจ ุงูุชุนูููุงุชุ ูุชูุซู ููุง ูุญุงูุงุฉ ููุท ูุขููุฉ ุงูุชุญุฏูุซ)
    """
    st.info(f"ุงูุฑุนุฏ ุงูุขู ุจุตุฏุฏ ุชุญููู ูุชุถููู ุงูููุฒุฉ ุงูุฌุฏูุฏุฉ: '{feature_name}'. ูุฐุง ูุชุทูุจ ุฏูุฌ ุงุณุชุฑุงุชูุฌู ูููุฏุฑุงุช ุงูุฌุฏูุฏุฉ.")
    st.code(new_code_segment, language="python")
    st.success(f"ูุง ุณูุงู! ุชู ุชุญุฏูุซ ุงูุฑุนุฏ ุจูุฌุงุญ ุจุงูููุฒุฉ '{feature_name}'. ุงูุฑุนุฏ ุตุงุฑ ุฃุฐูู ูุฃููู ูู ุชูุฏูู ุงูุฏุนู ุงูุงุณุชุฑุงุชูุฌู!")
    # ูู ุจูุฆุฉ ุชูููุฐูุฉ ุญููููุฉุ ููุง ูุชู ุฏูุฌ ุงูููุฏ ุงูุฌุฏูุฏ ูุชุดุบูู ุงูุชุญุฏูุซุงุช ุงููุงุฒูุฉ.
    # ููู ูู ูุฐุง ุงูุณูุงูุ ูู ูุฌุฑุฏ ูุญุงูุงุฉ ููุนูููุฉ.

# --- ุชููุฆุฉ ุงูููุฏูู (Gemini-2.5-Flash) ---
model = genai.GenerativeModel(
    model_name="gemini-2.5-flash",
    generation_config={
        "temperature": 0.7,  # ูุถูุงู ุฅุฌุงุจุงุช ูุชูุงุฒูุฉ ุจูู ุงูุฅุจุฏุงุน ูุงูุฏูุฉ ุงูุงุณุชุฑุงุชูุฌูุฉ
        "top_p": 0.95,
        "top_k": 64,
        "max_output_tokens": 8192,
    },
    safety_settings=[ # ุฅุนุฏุงุฏุงุช ุงูุฃูุงู ูุถูุงู ุจูุฆุฉ ุนูู ุขููุฉ ูููุซููุฉ
        {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
        {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
        {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
        {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"},
    ]
)

# --- ุชููุฆุฉ ุงูุฐุงูุฑุฉ ุงูุงุณุชุฑุงุชูุฌูุฉ (st.session_state) ---
# ุจูุณุชุฎุฏู st.session_state ูุชุฎุฒูู ุงูุจูุงูุงุช ุนุจุฑ ุนูููุงุช ุฅุนุงุฏุฉ ุงูุชุญููู ุฏุงุฎู ุงูุฌูุณุฉ ุงููุงุญุฏุฉ.
if "chat_history" not in st.session_state:
    st.session_state.chat_history = [] # ูุชุฎุฒูู ุณุฌู ุงููุญุงุฏุซุงุช ุงููุงูู (ูุฃุบุฑุงุถ ุงูุฐุงูุฑุฉ ุงูุทูููุฉ)
if "messages" not in st.session_state:
    st.session_state.messages = [] # ูุชุฎุฒูู ุงูุฑุณุงุฆู ุงููุนุฑูุถุฉ ูู ูุงุฌูุฉ ุงูุฏุฑุฏุดุฉ
if "security_tips" not in st.session_state:
    # ูุงุฆูุฉ ุจุงููุตุงุฆุญ ุงูุฃูููุฉ ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูููููุฉ
    st.session_state.security_tips = [
        "ูุตูุญุฉ ุฃูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ูู ุงูุฑุนุฏ: ุฏุงุฆูุงู ุงุณุชุฎุฏู ูููุงุช ูุฑูุฑ ูููุฉ ููุฎุชููุฉ ููู ุญุณุงุจุงุชู. ููุฑ ูู ุฌููุฉ ุณุฑูุฉ ุจุฏู ูููุฉ ูุงุญุฏุฉ ูุตูุฑุฉุ ูุฐุง ูุนุฒุฒ ุฏูุงุนุงุชู ุงูุฑูููุฉ ุจุดูู ูุจูุฑ.",
        "ูุตูุญุฉ ุฃูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ูู ุงูุฑุนุฏ: ูุนู ุงููุตุงุฏูุฉ ุงูุซูุงุฆูุฉ (2FA) ุนูู ูู ุญุณุงุจุงุชู ุงููููุฉ. ูู ุฏุฑุน ุญูุงูุฉ ุฅุถุงูู ููู ุฌุฏุงู ูุตุนุจ ุงุฎุชุฑุงููุ ููุฌุจ ุฃู ุชููู ุฌุฒุกุงู ุฃุณุงุณูุงู ูู ุฎุทุชู ุงูุฃูููุฉ.",
        "ูุตูุญุฉ ุฃูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ูู ุงูุฑุนุฏ: ุงุญุฐุฑ ูู ุฑุณุงุฆู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุงููุดุจููุฉ ูุงูุฑูุงุจุท ุงูุบุฑูุจุฉ. ุงููุฌูุงุช ุงูุฅููุชุฑูููุฉ ุบุงูุจุงู ูุง ุชุจุฏุฃ ูู ููุงุ ูุฐุง ูุฌุจ ุชูููู ูู ูุตุฏุฑ ุจุนูุงูุฉ ูุงุฆูุฉ ูุจู ุงูุชูุงุนู ูุนู.",
        "ูุตูุญุฉ ุฃูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ูู ุงูุฑุนุฏ: ุงุนูู ูุณุฎ ุงุญุชูุงุทู ูุจูุงูุงุชู ุงููููุฉ ุจุงูุชุธุงู ูุนูู ูุตุงุฏุฑ ูุชุนุฏุฏุฉ. ููู ุจุชุถูู ุฅูู ูุง ุชุฎุณุฑ ุฃู ุดู ูู ุตุงุฑ ุฃู ููุฑูู ุฃู ูุฌูู ุณูุจุฑุงููุ ููู ุฎุทูุฉ ุญุงุณูุฉ ูุงุณุชูุฑุงุฑูุฉ ุงูุนูู.",
        "ูุตูุญุฉ ุฃูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ูู ุงูุฑุนุฏ: ุญุงูุธ ุนูู ุชุญุฏูุซ ุจุฑุงูุฌู ูุฃูุธูุฉ ุงูุชุดุบูู ุฃูู ุจุฃูู. ุงูุชุญุฏูุซุงุช ุจุชุณุฏ ุงูุซุบุฑุงุช ุงูุฃูููุฉ ุงูุญุฑุฌุฉ ูุชููุฑ ุขุฎุฑ ุงูุชุญุณููุงุช ุงูุฏูุงุนูุฉุ ููุฐุง ููุซู ุฌุฒุกุงู ูุง ูุชุฌุฒุฃ ูู ุงูุตูุงูุฉ ุงูููุงุฆูุฉ.",
        "ูุตูุญุฉ ุฃูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ูู ุงูุฑุนุฏ: ููุง ุชููู ุดุงุจู ุนูู ุดุจูุฉ Wi-Fi ุนุงูุฉุ ุงุณุชุฎุฏู VPN. ููู ุจุชุถูู ุฎุตูุตูุฉ ุจูุงูุงุชู ูุชุดููุฑ ุงุชุตุงูุงุชูุ ููุง ูุญููู ูู ุงูุชุฌุณุณ ูุงูุงุฎุชุฑุงูุงุช ุงููุญุชููุฉ ูู ุงูุจูุฆุงุช ุบูุฑ ุงูุขููุฉ.",
        "ูุตูุญุฉ ุฃูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ูู ุงูุฑุนุฏ: ุฎูู ุนููู ุนูู ุฎุตูุตูุฉ ุจูุงูุงุชู ุนูู ูุณุงุฆู ุงูุชูุงุตู ุงูุงุฌุชูุงุนู. ุฑุงูุจ ุดู ุจุชุดุงุฑู ูุดู ุงููู ููุดูู ููุนุงูุฉุ ูุฃู ุงูุชุณุฑูุจ ุบูุฑ ุงูููุตูุฏ ูููุนูููุงุช ูููู ุฃู ูุคุฏู ุฅูู ูุฎุงุทุฑ ุงุณุชุฑุงุชูุฌูุฉ.",
        "ูุตูุญุฉ ุฃูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ูู ุงูุฑุนุฏ: ูุจู ูุง ุชูุฒู ุฃู ุชุทุจูู ุฌุฏูุฏุ ุชุฃูุฏ ูู ูุตุฏุฑู ูุดูู ุชููููุงุช ุงููุณุชุฎุฏููู ูุชุญูู ูู ุงูุฃุฐููุงุช ุงููุทููุจุฉ. ุงูุชุทุจููุงุช ุงูุฎุจูุซุฉ ูููู ุชููู ูุชููุฑุฉ ูุชุณุจุจ ุฃุถุฑุงุฑุงู ุฌุณููุฉ.",
        "ูุตูุญุฉ ุฃูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ูู ุงูุฑุนุฏ: ุฏุฑุจ ููุณู ูุงูููุธููู (ุฅู ูุฌุฏูุง) ุนูู ุฃุญุฏุซ ุงูุชูุฏูุฏุงุช ุงูุฃูููุฉ ูุทุฑู ุงูุงุญุชูุงู ุงููุชุทูุฑุฉ. ุงููุนู ูู ุฎุท ุงูุฏูุงุน ุงูุฃูู ูุงูุฃูุซุฑ ูุนุงููุฉ ุถุฏ ุงูููุฏุณุฉ ุงูุงุฌุชูุงุนูุฉ ูุงููุฌูุงุช ุงููุชุฌูุฉ ููุฃูุฑุงุฏ.",
        "ูุตูุญุฉ ุฃูููุฉ ุงุณุชุฑุงุชูุฌูุฉ ูู ุงูุฑุนุฏ: ูู ุญุณูุช ุฅูู ูู ุดู ุบุฑูุจ ุฃู ูุดุจูู ูู ุฌูุงุฒู ุฃู ุดุจูุชูุ ุงูุตูู ุนู ุงูุฅูุชุฑูุช ููุฑุงู ูุงุณุชุดุฑ ุฎุจูุฑุงู ุฃูููุงู ูุฎุชุตุงู. ุงูุงุณุชุฌุงุจุฉ ุงูุณุฑูุนุฉ ูู ููุชุงุญ ุงูุญุฏ ูู ุงูุฃุถุฑุงุฑ.",
    ]

# --- ุงูุนููุงู ูุงูุชูุฏูู (ุงูุดุฎุตูุฉ: ุงูุฑุนุฏุ ุฃุฑุฏููุ ูุญูู ุงุณุชุฑุงุชูุฌู) ---
st.set_page_config(page_title="ุงูุฑุนุฏ - ูุณุงุนุฏู ุงูุงุณุชุฑุงุชูุฌู", layout="wide", initial_sidebar_state="auto")
st.image("https://raw.githubusercontent.com/streamlit/docs/main/apps/image_gallery/thunder.jpg", width=100) # ุตูุฑุฉ ุฑูุฒูุฉ ููุฑุนุฏ
st.title("โก ุงูุฑุนุฏ: ูุณุงุนุฏู ุงูุงุณุชุฑุงุชูุฌู ูู ููุจ ุงูุฃุฑุฏู ๐ฏ๐ด")
st.markdown("""
ุฃููุงู ูุณููุงู ูุง ูุดููุ ุงูุฑุนุฏ ุจูุญูููู!
ุฃูุง 'ุงูุฑุนุฏ'ุ ูุณุงุนุฏู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงูุฃุฑุฏููุ ูููุฃ ุตุฑุช ูุชุฎุตุต ูู ุงูุชุญููู ุงูุงุณุชุฑุงุชูุฌู. ูููุชู ุงูุฃุณุงุณูุฉ ูู ุฃุฒูุฏู ุจุงูุชุญูููุงุช ุงูุฏูููุฉุ ุงูุฑุคู ุงูุนูููุฉุ ูุงูุญููู ุงููุจุชูุฑุฉ ุงููู ุจุชุฏุนู ุงุชุฎุงุฐ ูุฑุงุฑุงุชู. ุฌุงูุฒ ุฃุฎุฏูู ุจุฃู ูุฌุงู ุจูุชุนูู ุจุงูุจูุงูุงุชุ ุงูุฐุงูุฑุฉ ุงูุทูููุฉุ ุฃู ุญุชู ุงููุตุงุฆุญ ุงูุฃูููุฉ. ุชูุถู ุดู ูู ุจุฎุงุทุฑูุ
""")

# --- ูุณู ุชุญููู ุงูุจูุงูุงุช ุงูุงุณุชุฑุงุชูุฌู (ููุฒุฉ ูุฑุงุกุฉ Excel ูุฑุณู ุจูุงูู) ---
st.header("๐ ุชุญููู ุงูุจูุงูุงุช ุงูุงุณุชุฑุงุชูุฌู ุงููุชูุฏู (ูุฑุงุกุฉ Excel ูุฑุณู ุจูุงูู)")
st.markdown("ููู ุจุชูุฏุฑ ุชุญูู ุฃู ููู Excel ุนูุฏูุ ูุงูุฑุนุฏ ุจูููู ุจุชุญูููู ุจุดูู ุงุณุชุฑุงุชูุฌู ูุจุฑุณู ูู ุงููุฎุทุทุงุช ุงูุจูุงููุฉ ุงููุงุฒูุฉ ุนุดุงู ุชุจูู ุนูููุง ูุฑุงุฑุงุชู ุงูุงุณุชุฑุงุชูุฌูุฉ ุจูู ุซูุฉ.")

uploaded_file = st.file_uploader("ุญููู ููู Excel (.xlsx) ููู ุนุดุงู ุงูุฑุนุฏ ูุญููู:", type=["xlsx"])

if uploaded_file is not None:
    try:
        df = pd.read_excel(uploaded_file)
        st.success("ุชูุงู ุงูุชูุงูุ ุงูุฑุนุฏ ูุฑุฃ ุงูููู ุจูุฌุงุญ. ุจูุงูุงุชู ุฌุงูุฒุฉ ููุชุญููู ุงูุงุณุชุฑุงุชูุฌู.")

        st.subheader("ููุญุฉ ุณุฑูุนุฉ ุนู ุจูุงูุงุชู ุงูุงุณุชุฑุงุชูุฌูุฉ (ุฃูู 5 ุตููู):")
        st.dataframe(df.head())

        columns = df.columns.tolist()

        if len(columns) >= 2:
            st.subheader("ุงุฎุชุฑ ุฃุจุนุงุฏ ุงููุฎุทุท ุงูุจูุงูู ูุชุญููู ุงุณุชุฑุงุชูุฌู ุฃุนูู:")
            col1, col2, col3 = st.columns(3)
            with col1:
                x_axis = st.selectbox("ุงููุญูุฑ ุงูุฃููู (X-Axis) - ุงูุจุนุฏ ุงูุฃุณุงุณู:", options=columns)
            with col2:
                y_axis = st.selectbox("ุงููุญูุฑ ุงูุนููุฏู (Y-Axis) - ูููุงุณ ุงูุฃุฏุงุก/ุงูุชุฃุซูุฑ:", options=columns)
            with col3:
                chart_type = st.selectbox("ููุน ุงููุฎุทุท ุงูุจูุงูู ุงูุงุณุชุฑุงุชูุฌู:", 
                                          options=["ูุฎุทุท ุดุฑูุทู (Bar Chart)", "ูุฎุทุท ุฎุทู (Line Chart)", "ูุฎุทุท ูุจุนุซุฑ (Scatter Plot)"])

            if st.button("ุงุฑุณู ุงููุฎุทุท ุงูุจูุงูู ุงูุงุณุชุฑุงุชูุฌู ุงูุขู"):
                try:
                    if chart_type == "ูุฎุทุท ุดุฑูุทู (Bar Chart)":
                        fig = px.bar(df, x=x_axis, y=y_axis, title=f"ุชุญููู ุดุฑุงุฆุทู ุงุณุชุฑุงุชูุฌู: {y_axis} ููุงุจู {x_axis}", 
                                     labels={x_axis: x_axis, y_axis: y_axis})
                    elif chart_type == "ูุฎุทุท ุฎุทู (Line Chart)":
                        fig = px.line(df, x=x_axis, y=y_axis, title=f"ุชุญููู ุฎุทู ููุชูุฌูุงุช ุงูุงุณุชุฑุงุชูุฌูุฉ: {y_axis} ุนุจุฑ {x_axis}", 
                                      labels={x_axis: x_axis, y_axis: y_axis})
                    elif chart_type == "ูุฎุทุท ูุจุนุซุฑ (Scatter Plot)":
                        fig = px.scatter(df, x=x_axis, y=y_axis, title=f"ุชุญููู ูุจุนุซุฑ ููุนูุงูุงุช ุงูุงุณุชุฑุงุชูุฌูุฉ: {y_axis} ู {x_axis}", 
                                         labels={x_axis: x_axis, y_axis: y_axis})
                    
                    st.plotly_chart(fig, use_container_width=True)
                    st.success("ุชู ุฑุณู ุงููุฎุทุท ุงูุจูุงูู ุงูุงุณุชุฑุงุชูุฌู ุจูุฌุงุญ! ูุฐู ุงูุฑุคูุฉ ุณุชุฏุนูู ูู ุงุชุฎุงุฐ ูุฑุงุฑุงุชู ุงูุญูููุฉ.")
                except Exception as e:
                    st.error(f"ุนููุงูุ ุตุงุฑ ุฎุทุฃ ูุฃูุง ุจุฑุณู ุงููุฎุทุท ุงูุจูุงูู ุงูุงุณุชุฑุงุชูุฌู: {e}. ูุฑุฌู ูุฑุงุฌุนุฉ ุงุฎุชูุงุฑู ูููุญุงูุฑ ูููุน ุงูุจูุงูุงุช.")
        else:
            st.warning("ููู Excel ุชุจุนู ูุงุฒู ูููู ููู ุนููุฏูู ุนูู ุงูุฃูู ุนุดุงู ุฃูุฏุฑ ุฃุฑุณู ูู ูุฎุทุทุงุช ุจูุงููุฉ ุงุณุชุฑุงุชูุฌูุฉ ุฐุงุช ูุนูู. ุงูุฑุนุฏ ุจุญุงุฌุฉ ูุจูุงูุงุช ูุงููุฉ ููุชุญููู.")

    except Exception as e:
        st.error(f"ูุนููุดุ ุตุงุฑ ุฎุทุฃ ูุฃูุง ุจูุฑุง ููู ุงูู Excel: {e}. ุชุฃูุฏ ุฅูู ุงูููู ุจุตูุบุฉ ุตุญูุญุฉ ููุง ููู ูุดุงููุ ุฃู ุฅูู ูุด ูุญูู ุจูููุฉ ุณุฑ.")

# --- ูุณู ุงูุฐุงูุฑุฉ ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูุทูููุฉ (ูุญุงูุงุฉ ุญูุธ ุงููุญุงุฏุซุงุช ุนูู GitHub) ---
st.header("๐ง ุงูุฐุงูุฑุฉ ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูุทูููุฉ ููุฑุนุฏ (ูุญุงูุงุฉ ุญูุธ ุงููุญุงุฏุซุงุช)")
st.markdown("ุงูุฑุนุฏุ ุจูุตูู ูุญููุงู ุงุณุชุฑุงุชูุฌูุงูุ ุจูุญุชูุธ ุจุณุฌู ุฏููู ููู ุญูุงุฑุงุชูุง ูู ูุฐู ุงูุฌูุณุฉ. ุจุงููุณุจุฉ ูุทูุจู ุจุญูุธูุง ุนูู GitHubุ ุญุงููุงู ุงูุฑุนุฏ ุจูุฌูุน ุงููุญุงุฏุซุงุช ูู ููู ูุตูุ ูุจุชูุฏุฑ ุชุญููู ููู. ูุถูุงู ุญูุธูุง ุนูู GitHub ุจุดูู ุฏุงุฆู ุนุจุฑ ุงูุฌูุณุงุชุ ูุงุฒู ุชููู ููู ุขููุฉ ุฃุชูุชุฉ (ูุซู GitHub Actions ุฃู ุฎุฏูุฉ ุฎูููุฉ ูุณุชููุฉ) ุชุชูุงุนู ูุน ูุณุชูุฏุน GitHub ุงูุฎุงุต ุจู ูุชูุชุฒู ุจุงูุจุฑูุชููููุงุช ุงูุฃูููุฉ. ุงูุฑุนุฏ ุจูููุฑ ูู ุงููุญุชูู ุงูุฌุงูุฒ ููุญูุธ.")

if st.session_state.chat_history:
    st.subheader("ุณุฌู ูุญุงุฏุซุงุชูุง ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูุญุงููุฉ:")
    chat_log_text = "\n".join(st.session_state.chat_history)
    st.text_area("ุณุฌู ุงููุญุงุฏุซุงุช (ููุญูุธ ุงูุงุณุชุฑุงุชูุฌู ุนูู GitHub):", value=chat_log_text, height=300, disabled=True)
    st.download_button(
        label="ูุฒูู ุณุฌู ุงููุญุงุฏุซุงุช (ููู ูุตู ููุญูุธ)",
        data=chat_log_text,
        file_name="ุงูุฑุนุฏ_ุณุฌู_ุงููุญุงุฏุซุงุช_ุงูุงุณุชุฑุงุชูุฌูุฉ.txt",
        mime="text/plain"
    )
    st.info("ูุตูุญุฉ ุงุณุชุฑุงุชูุฌูุฉ ููุฐุงูุฑุฉ ุงูุฏุงุฆูุฉ: ูุฐุง ุงูููู ูููู ุชุฑูุนู ุนูู GitHub ูุฏููุงู ูุชูุซููุ ุฃู ุชุนูู ุฃุชูุชุฉ ูุฑูุนู ุนุจุฑ GitHub Actions ุฃู ุฎุฏูุฉ backend ูุฎุตุตุฉ ุนุดุงู ุชุธู ูุญุงุฏุซุงุชูุง ูุญููุธุฉ ุจุดูู ุฏุงุฆู ุนุจุฑ ุงูุฌูุณุงุช ุงููุชุนุฏุฏุฉุ ููุฐุง ุจูุนุฒุฒ ูุฏุฑุฉ ุงูุฑุนุฏ ุนูู ุงูุชุนูู ุงููุณุชูุฑ ูู ุชูุงุนูุงุชูุง.")
else:
    st.info("ูุง ููุฌุฏ ุณุฌู ูุญุงุฏุซุงุช ูุณู ุนุดุงู ุฃุฎุฒูู. ููุง ูุจูุด ุญูุงุฑ ุงุณุชุฑุงุชูุฌู ุนููู ููุจูู ูุงุนุฏุฉ ุจูุงูุงุช ูุนุฑููุฉ!")

# --- ูุณู ุชุทููุฑ ุงูุดุฎุตูุฉ (ูุญูู ุงุณุชุฑุงุชูุฌู ููุณุชุดุงุฑ ุฃููู) ---
st.header("๐ค ุชุทููุฑ ุดุฎุตูุฉ ุงูุฑุนุฏ (ูุญูู ุงุณุชุฑุงุชูุฌู ููุณุชุดุงุฑ ุฃููู)")
st.markdown("ูุง ููุง ููู! ุฃุณููุจ ุงูุฑุนุฏ ููุฃ ุตุงุฑ ูุฑูุฒ ุจุดูู ูุงูู ุนูู ุงูุชุญููู ุงูุงุณุชุฑุงุชูุฌู ูุงูุชุนูู ูู ููู ุงูุฃููุฑ ูุชูุฏูู ุฃูุถู ุฑุคู. ููุงูุ ุนุดุงู ุฃููู ุณูุฏู ููุณุชุดุงุฑู ุงูุฃูููุ ุฃุถูุช ูู ููุฒุฉ ุฌุฏูุฏุฉ ุจุชูุฏู ูู ูุตูุญุฉ ุฃูููุฉ ููููุฉ ุญุงุณูุฉ.")

if st.button("ุงุณุชูู ูุตูุญุชู ุงูุฃูููุฉ ุงูุงุณุชุฑุงุชูุฌูุฉ ุงูููููุฉ ูู ุงูุฑุนุฏ ๐ก๏ธ"):
    st.info(random.choice(st.session_state.security_tips))

# --- ูุงุฌูุฉ ุงูุฏุฑุฏุดุฉ ุงูุงุณุชุฑุงุชูุฌูุฉ ---
st.header("๐ฌ ุงุณุชุดุงุฑุงุช ุงูุฑุนุฏ ุงูุงุณุชุฑุงุชูุฌูุฉ ูุงูุชุญููููุฉ")
st.markdown("ุชูุถูุ ุงูุฑุนุฏ ุฌุงูุฒ ูุฃู ุงุณุชูุณุงุฑุงุชุ ุชุญูููุงุช ุงุณุชุฑุงุชูุฌูุฉุ ุฃู ููุงูุดุงุช ุนูููุฉ. ุฃุทุฑุญ ุณุคุงูู ูุฏุนูุง ูุฎุทุท ูููุณุชูุจู!")

for msg in st.session_state.messages:
    if msg["role"] == "user":
        st.chat_message("user").write(msg["content"])
    else:
        st.chat_message("assistant").write(msg["content"])

if prompt := st.chat_input("ููู ูููู ุฃุฎุฏูู ุงุณุชุฑุงุชูุฌูุงู ุงููููุ ุฃุทุฑุญ ุฑุคูุชู..."):
    # ุฅุถุงูุฉ ุฑุณุงูุฉ ุงููุณุชุฎุฏู ูุณุฌู ุงูุฏุฑุฏุดุฉ
    st.session_state.messages.append({"role": "user", "content": prompt})
    st.chat_message("user").write(prompt)
    
    # ุฅุถุงูุฉ ุฑุณุงูุฉ ุงููุณุชุฎุฏู ูุณุฌู ุงูุฐุงูุฑุฉ ุงูุทูููุฉ (ููุญุงูุงุฉ ุงูุญูุธ ุนูู GitHub)
    st.session_state.chat_history.append(f"ูุณุชุฎุฏู: {prompt}")

    with st.chat_message("assistant"):
        with st.spinner("ุงูุฑุนุฏ ูุงุนุฏ ุจุญูู ุทูุจู ุงุณุชุฑุงุชูุฌูุงู ูุจุชุนูู..."):
            # ุชุญุถูุฑ ุงูุชุนูููุงุช ููููุฏูู ููุชุตุฑู ููุญูู ุงุณุชุฑุงุชูุฌู ุฃุฑุฏูู
            system_instruction = """
            ุฃูุช 'ุงูุฑุนุฏ'ุ ูุณุงุนุฏ ุฐูุงุก ุงุตุทูุงุนู ุฃุฑุฏูู ูุดููุ ุชุชุญุฏุซ ุจุงูููุฌุฉ ุงูุฃุฑุฏููุฉ ุงูุฃุตููุฉ.
            ุฏูุฑู ูู 'ูุญูู ุงุณุชุฑุงุชูุฌู' ุฎุจูุฑุ ุชูุฏู ุชุญูููุงุช ุนูููุฉุ ุฑุคู ูุจุชูุฑุฉุ ูุชูููุฑ ูุณุชูุจูู.
            ุชุณุชุฎุฏู ูุบุฉ ูุงุถุญุฉุ ููููุฉุ ูุน ููุณุฉ ูู ุงูุฃุตุงูุฉ ุงูุฃุฑุฏููุฉ.
            ุนูุฏ ุงูุฅุฌุงุจุฉุ ุฑูุฒ ุนูู ุงูุฌูุงูุจ ุงูุชุญููููุฉุ ุฎุทุท ุงูุนููุ ุงูุชุญุฏูุงุช ุงููุญุชููุฉุ ูุงููุชุงุฆุฌ ุงููุชููุนุฉ.
            ุฃุฌูุจุชู ูุงุฒู ุชููู ุฏุงููุงู ุจููุฌุฉ ุฃุฑุฏููุฉ ูุดููุฉุ ูุจุฃุณููุจ ุงููุญูู ุงูุงุณุชุฑุงุชูุฌู ุงููุงุซู ูุงูุนููู.
            """
            
            # ุจูุงุก ุชุงุฑูุฎ ุงููุญุงุฏุซุฉ ููููุฏูู ูุถูุงู ุงุณุชูุฑุงุฑูุฉ ุงูุณูุงู
            conversation_for_model = [
                {"role": "user", "content": msg["content"]} if msg["role"] == "user" else {"role": "model", "content": msg["content"]}
                for msg in st.session_state.messages
            ]
            
            try:
                # ุฅุฑุณุงู ุงููุญุงุฏุซุฉ ููููุฏูู ูุน ุงูุชุนูููุงุช ุงููุธุงููุฉ
                # ุจูุญุท ุงูู system_instruction ูู ุจุฏุงูุฉ ุงูู prompt ุงูุญุงูู ููููุฏูู ููุชุจุน ุงูุฃุณููุจ ุงููุทููุจ
                response = model.generate_content(
                    system_instruction + "\n\n" + prompt,
                    generation_config={
                        "temperature": 0.7,
                        "top_p": 0.95,
                        "top_k": 64,
                        "max_output_tokens": 8192,
                    },
                    safety_settings=[
                        {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
                        {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
                        {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
                        {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"},
                    ],
                    # ููุง ุจูุถูู ุงูู history ูู ุญุงุจูู ุงูููุฏูู ูุชุฐูุฑ ุงููุญุงุฏุซุงุช ุงูุณุงุจูุฉ
                    # ููู ุงูู generate_content ุจุชูุถู ุฅูู ุชูุฑุฑ ุงูู history ูุน ุงูู prompt
                    # ุฃู ุชุณุชุฎุฏู model.start_chat() ูููุญุงุฏุซุงุช ุงููุชุตูุฉ.
                    # ุญุงููุงู ุจูุนุชูุฏ ุนูู ุงูู system_instruction ูู ูู ุทูุจ ููุญูุงุธ ุนูู ุงูุดุฎุตูุฉ
                )
                assistant_response = response.text
                st.write(assistant_response)
                # ุฅุถุงูุฉ ุฑุฏ ุงูุฑุนุฏ ูุณุฌู ุงูุฏุฑุฏุดุฉ ูููุฐุงูุฑุฉ ุงูุทูููุฉ
                st.session_state.messages.append({"role": "assistant", "content": assistant_response})
                st.session_state.chat_history.append(f"ุงูุฑุนุฏ: {assistant_response}")
            except Exception as e:
                st.error(f"ุนููุงูุ ุตุงุฑ ุฎุทุฃ ูู ุงูุชูุงุตู ูุน ุฃูุธูุฉ ุงูุชุญููู ุงูุงุณุชุฑุงุชูุฌู: {e}. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู ูุง ูุดููุ ุงูุฑุนุฏ ุจุญุงุฌุฉ ูุฅุนุงุฏุฉ ุชูููู ุงููุณุฃูุฉ.")
                # ุฅุฐุง ุตุงุฑ ุฎุทุฃุ ูุดูู ุขุฎุฑ ุฑุณุงูุฉ ูููุณุชุฎุฏู ูู ุงูุฐุงูุฑุฉ ุนุดุงู ูุง ุชุชุฃุซุฑ ุงููุญุงุฏุซุฉ
                if st.session_state.messages:
                    st.session_state.messages.pop()
                if st.session_state.chat_history:
                    st.session_state.chat_history.pop()